{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///Users/semiloreoshiyoye/Desktop/unibuddy/app/api/parse/route.ts"],"sourcesContent":["export const runtime = \"nodejs\";\n\nimport { NextRequest, NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\nimport mammoth from \"mammoth\";\n\n\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY! });\n\nfunction ext(name: string) {\n  const n = name.toLowerCase();\n  if (n.endsWith(\".pdf\")) return \"pdf\";\n  if (n.endsWith(\".docx\")) return \"docx\";\n  if (n.endsWith(\".txt\")) return \"txt\";\n  return \"other\";\n}\n\nasync function parsePdf(data: Uint8Array): Promise<string> {\n  const pdfjs: any = await import(\"pdfjs-dist/legacy/build/pdf.mjs\");\n\n  // âœ… MUST be a non-empty string (prevents \"No workerSrc specified\")\n  // With disableWorker:true, it should not actually spin up the worker,\n  // but pdf.js still wants a valid workerSrc for \"fake worker\" init.\n  pdfjs.GlobalWorkerOptions.workerSrc =\n    \"pdfjs-dist/legacy/build/pdf.worker.mjs\";\n\n  const loadingTask = pdfjs.getDocument({\n    data,\n    disableWorker: true,\n  });\n\n  const pdf = await loadingTask.promise;\n\n  let fullText = \"\";\n  for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {\n    const page = await pdf.getPage(pageNum);\n    const content = await page.getTextContent();\n    const strings = content.items.map((it: any) => it.str);\n    fullText += strings.join(\" \") + \"\\n\";\n  }\n\n  await pdf.destroy?.();\n  return fullText;\n}\nasync function fileToText(file: File): Promise<string> {\n  const ab = await file.arrayBuffer();\n  const type = ext(file.name);\n\n  if (type === \"pdf\") {\n    const data = new Uint8Array(ab);\n    return await parsePdf(data);\n  }\n\n  const buffer = Buffer.from(ab);\n\n  if (type === \"docx\") {\n    const result = await mammoth.extractRawText({ buffer });\n    return result?.value || \"\";\n  }\n\n  if (type === \"txt\") {\n    return buffer.toString(\"utf-8\");\n  }\n\n  return \"\";\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const formData = await req.formData();\n    const files = formData.getAll(\"files\") as File[];\n\n    if (!files?.length) {\n      return NextResponse.json({ error: \"No files uploaded\" }, { status: 400 });\n    }\n    if (files.length > 6) {\n      return NextResponse.json({ error: \"Max 6 files\" }, { status: 400 });\n    }\n\n    const parts: string[] = [];\n    for (const f of files) {\n      const type = ext(f.name);\n      if (![\"pdf\", \"docx\", \"txt\"].includes(type)) {\n        return NextResponse.json(\n          { error: \"Only PDF, DOCX, or TXT files are supported.\" },\n          { status: 400 }\n        );\n      }\n\n      const text = await fileToText(f);\n      parts.push(`--- FILE: ${f.name} ---\\n${text}`);\n    }\n\n    const combinedText = parts.join(\"\\n\\n\").slice(0, 180000);\n\n    const prompt = `\nExtract ALL dated items (assignments, quizzes, labs, midterms, finals, projects).\nReturn STRICT JSON ARRAY ONLY. No markdown. No explanation.\n\nSchema:\n[\n  { \"priority\": 1, \"title\": \"Assignment 1\", \"course\": \"COMP 2540\", \"date\": \"2026-02-15\", \"notes\": \"\" }\n]\n\nRules:\n- date must be YYYY-MM-DD\n- priority: 1=high, 2=medium, 3=low\n- include every dated assessment you can find\n\nText:\n\"\"\"${combinedText}\"\"\"\n`;\n\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      temperature: 0.2,\n      messages: [{ role: \"user\", content: prompt }],\n    });\n\n    const raw = completion.choices[0]?.message?.content?.trim() || \"[]\";\n\n    let tasks: any[] = [];\n    try {\n      tasks = JSON.parse(raw);\n    } catch {\n      const first = raw.indexOf(\"[\");\n      const last = raw.lastIndexOf(\"]\");\n      tasks = first !== -1 && last !== -1 ? JSON.parse(raw.slice(first, last + 1)) : [];\n    }\n\n    return NextResponse.json({ success: true, tasks });\n  } catch (error: any) {\n    console.error(\"Parse error:\", error);\n    return NextResponse.json({ error: error.message || \"Parse failed\" }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}